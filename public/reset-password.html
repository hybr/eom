<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Process Execution System</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/auth.css">
</head>
<body>
    <div id="reset-password-container" class="auth-container">
        <div class="auth-form-container">
            <div class="auth-header">
                <h2>Reset Your Password</h2>
                <p>Enter your new password below</p>
            </div>

            <form id="reset-password-form" class="auth-form" data-type="reset-password">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <input type="password" id="password" name="password" required>
                    <small class="form-help">At least 8 characters with uppercase, lowercase, number, and special character</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>

                <button type="submit" class="btn btn-primary auth-submit">
                    <span class="btn-text">Reset Password</span>
                    <span class="loading" style="display: none;"></span>
                </button>

                <div class="auth-links">
                    <a href="index.html">Back to Login</a>
                </div>
            </form>

            <div id="auth-messages"></div>
        </div>
    </div>

    <script type="module">
        import AuthenticationService from 'src/services/AuthenticationService.js';
        import EmailService from 'src/services/EmailService.js';

        class PasswordResetPage {
            constructor() {
                this.authService = new AuthenticationService();
                this.emailService = new EmailService({ mockMode: true });
                this.setupEventListeners();
                this.checkToken();
            }

            setupEventListeners() {
                document.getElementById('reset-password-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit(e.target);
                });
            }

            checkToken() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (!token) {
                    this.showMessage('Invalid or missing reset token. Please request a new password reset.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            }

            async handleSubmit(form) {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);

                this.clearMessages();
                this.setLoading(true);

                try {
                    if (data.password !== data.confirmPassword) {
                        throw new Error('Passwords do not match');
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');

                    const result = await this.authService.resetPassword(token, data.password);

                    if (result.success) {
                        this.showMessage('Password reset successful! Redirecting to login...', 'success');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    this.showMessage(error.message, 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            showMessage(message, type = 'info') {
                const messagesContainer = document.getElementById('auth-messages');
                if (!messagesContainer) return;

                messagesContainer.innerHTML = '';
                const messageDiv = document.createElement('div');
                messageDiv.className = `${type}-message`;
                messageDiv.textContent = message;
                messagesContainer.appendChild(messageDiv);
            }

            clearMessages() {
                const messagesContainer = document.getElementById('auth-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }
            }

            setLoading(isLoading) {
                const submitButton = document.querySelector('.auth-submit');
                const text = submitButton.querySelector('.btn-text');
                const loading = submitButton.querySelector('.loading');

                if (isLoading) {
                    submitButton.disabled = true;
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                } else {
                    submitButton.disabled = false;
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                }
            }
        }

        new PasswordResetPage();
    </script>
</body>
</html>